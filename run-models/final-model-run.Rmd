---
title: "Final Run of All Plots"
author: "Briana Barajas"
date: 2024-05-08
---

## Preparation

```{r}
rm(list = ls())

# wrangling
library(tidyverse)
library(here)
library(janitor)

# raster/geospatial
library(sf)
library(tmap)
library(terra)

# modeling
library(SDMtune)
library(rsample)
library(rJava)

# set data directory
rast_dir <- here("data", "raster-stacks")
point_dir <- here("data", "CampRoberts_spatial_data")

# source functions
source(here("functions", "sdmtune-brt-final-function.R"))
#source(here("sdmtune-final-models", "sdmtune-brt-final-function.R"))

# occurrence points
points <- read_sf(here(point_dir, "Species_pts", "CR_BASP_obs_11Jul22.shp"), quiet = TRUE) %>% 
  clean_names() %>% 
  filter(plot == 1)
```

## Plot Summary

Each plot indicates a different transect where cover board surveys were conducted, and contains it's own unique values of occurrence points. The maximum entropy model is often noted for it's capabilities even when given a small data set. Since each plot has a unique number of occurrence points, some of the analyses conducted compare plots with low vs. high numbers of points to see how the AUC was affected.

| Plot Number | Number of Occurrences |
|-------------|----------------------|
| 1           | 51                   |
| 2           | 57                   |
| 3           | 78\*                 |
| 4           | 19                   |
| 5           | 72                   |
| 6           | 39                   |
| 7           | 10\*                 |
| 8           | 21                   |

## Test BRT Function
```{r}
# run model
brt_res <- tune_brt(plot_number = 1,
                    point_dir = point_dir,
                    rast_dir = rast_dir,
                    k_folds = 3)

# pull models from results
brt_test_obj <- brt_res[["brt_test"]]
brt_pred_stack <- brt_res[["brt_pred_stack"]]
brt_gs <- brt_res[["brt_gs"]]
brt_full_model <- brt_res[["brt_model"]]
brt_reduced_model <- brt_res[["brt_mod_reduced"]]

# isolate the top performing model & predict
brt_id <- which.max(brt_gs@results$test_AUC)
brt_best_mod <- combineCV(brt_gs@models[[brt_id]])
brt_map <- predict(brt_best_mod, data = brt_pred_stack)

# plot results
plotROC(brt_best_mod, test = brt_test_obj)

tm_shape(brt_map) +
  tm_raster(midpoint = 0) +
  tm_shape(points) +
  tm_dots(size = 0.1) +
  tm_layout(legend.position = c(1, 0.2))
```


## Test Maxent Function
```{r}
# run model
maxent_res <- tune_maxent(plot_number = 1,
                          point_dir = point_dir,
                          rast_dir = rast_dir,
                          k_folds = 3)

# pull models from results
maxent_test_obj <- maxent_res[["maxent_test"]]
maxent_pred_stack <- maxent_res[["maxent_pred_stack"]]
maxent_gs <- maxent_res[["maxent_gs"]]
maxent_full_model <- maxent_res[["maxent_model"]]
maxent_reduced_model <- maxent_res[["maxent_mod_reduced"]]

# isolate the top performing model & predict
maxent_id <- which.max(maxent_gs@results$test_AUC)
maxent_best_mod <- combineCV(maxent_gs@models[[maxent_id]])
maxent_map <- predict(maxent_best_mod, data = maxent_pred_stack,
                      type = "cloglog",
                      clamp = TRUE)

# plot results
plotROC(maxent_best_mod, test = maxent_test_obj)

tm_shape(maxent_map) +
  tm_raster(midpoint = 0) +
  tm_shape(points) +
  tm_dots(size = 0.1) +
  tm_layout(legend.position = c(1, 0.2))

```

## Comparing Values of K

```{r}
# # list potential values of K
# k_list <- seq(5, 50, 5)
# 
# # create empty data frames for predictions
# maxent_df <- data.frame()
# brt_df <- data.frame()
# 
# 
# 
# # model predictions for all value of k
# for (i in k_list) {
#   
#   # maxent predictions
#   print(paste0("Maxent modeling with k = ", i))
#   maxent_results <- tune_maxent(3, point_dir, rast_dir, i, 1000)
#   maxent_gs <- maxent_results[["maxent_gs"]]
#   
#   # add to data frame
#   new_row <- as.data.frame(maxent_gs@results) %>% slice_max(order_by = test_AUC)
#   new_row$k <- i
#   maxent_df <- rbind(maxent_df, new_row)
#   
#   # BRT predictions
#   print(paste0("BRT modeling with k = ", i))
#   brt_results <- tune_brt(3, point_dir, rast_dir, i, 1000)
#   brt_gs <- brt_results[["brt_gs"]]
#   
#   # add to data frame
#   new_row <- as.data.frame(brt_gs@results) %>% slice_max(order_by = test_AUC)
#   new_row$k <- i
#   brt_df <- rbind(brt_df, new_row)
# }
# 
# # save results
# write_csv(brt_df, here("outputs", "input-auc-assessment", "brt_k_folds.csv"))
# write_csv(maxent_df, here("outputs", "input-auc-assessment", "maxent_k_folds.csv"))

# read in results
brt_df <-read_csv(here("outputs", "input-auc-assessment", "brt_k_folds.csv"))
maxent_df <- read_csv(here("outputs", "input-auc-assessment", "maxent_k_folds.csv"))

# plot results
ggplot(brt_df, aes(k, test_AUC)) +
  geom_point(col = "darkorange3", size = 2) +
  geom_smooth(se = FALSE, col = "darkorange") +
  theme_minimal() +
  labs(y = "Test AUC", title = "BRT K-fold Assessment")

ggplot(maxent_df, aes(k, test_AUC)) +
  geom_point(col = "darkblue", size = 2) +
  geom_smooth(se = FALSE) +
  theme_minimal() +
  labs(y = "Test AUC", title = "Maxent K-fold Assessment")

```


## Comparing the Number of Background Points

```{r, eval=FALSE}
# ..........................calculate AUC for varying bg_points...................
# list potential number of background points
bg_list <- c(10, 120, 230, 340, 450, 560, 670, 780, 890, 1000)

# create empty data frames for predictions
maxent_df1 <- data.frame()
brt_df2 <- data.frame()


# model predictions for all number of bg points
for (i in bg_list) {
  
  # # maxent predictions
  # print(paste0("maxent modeling with bg_points = ", i))
  # maxent_results <- tune_maxent(3, point_dir, rast_dir, 5, i)
  # maxent_gs <- maxent_results[["maxent_gs"]]
  # 
  # # add to data frame
  # new_row <- as.data.frame(maxent_gs@results) %>% slice_max(order_by = test_AUC)
  # new_row$bg_points <- i
  # maxent_df1 <- rbind(maxent_df1, new_row)
  
  # BRT predictions
  print(paste0("brt modeling with bg_points = ", i))
  brt_results <- tune_brt(3, point_dir, rast_dir, 5, i)
  brt_gs <- brt_results[["brt_gs"]]
  
  # add to data frame
  new_row <- as.data.frame(brt_gs@results) %>% slice_max(order_by = test_AUC)
  new_row$bg_points <- i
  brt_df2 <- rbind(brt_df2, new_row)
}

# ...........................clean data.............................
brt_df1$only_presence <- "False"
brt_df2$only_presence <- "True"

brt_df_bg <- rbind(brt_df1, brt_df2)


# ..........................plot results............................

ggplot(maxent_df1, aes(bg_points, test_AUC)) +
  geom_point(col = "darkorange3", size = 2) +
  geom_smooth(se = FALSE, col = "darkorange") +
  labs(x = "Number of Background Points", y = "Test AUC", title = "Maxent - Baxkground Point Assessment") +
  theme_minimal()

ggplot(brt_df_bg, aes(bg_points, test_AUC, col = only_presence, shape = only_presence)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("maroon", "navy")) +
  geom_smooth(se = FALSE, aes(col = only_presence)) +
  labs(x = "Number of Background Points", y = "Test AUC", title = "BRT - Background Point Assessment") +
  theme_minimal()

```



