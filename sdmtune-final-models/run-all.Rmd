---
title: "Final Run of All Plots"
author: "Briana Barajas"
date: 2024-05-08
---

## Preparation

```{r}
rm(list = ls())

# wrangling
library(tidyverse)
library(here)
library(janitor)

# raster/geospatial
library(sf)
library(tmap)
library(terra)

# modeling
library(SDMtune)
library(rsample)
library(rJava)

# set data directory
rast_dir <- here("data", "updated-rasters")
point_dir <- here("data", "CampRoberts_spatial_data")

# source functions
source(here("sdmtune-final-models", "sdmtune-maxent-final-function.R"))
source(here("sdmtune-final-models", "sdmtune-brt-final-function.R"))

```

## Plot Summary

Each plot indicates a different transect where cover board surveys were conducted, and contains it's own unique values of occurrence points. The maximum entropy model is often noted for it's capabilities even when given a small data set. Since each plot has a unique number of occurence points, some of the analyses conducted compare plots with low vs. high numbers of points to see how the AUC was affected.

| Plot Number | Number of Occurences |
|-------------|----------------------|
| 1           | 51                   |
| 2           | 57                   |
| 3           | 78\*                 |
| 4           | 19                   |
| 5           | 72                   |
| 6           | 39                   |
| 7           | 10\*                 |
| 8           | 21                   |

## Comparing Values of K

```{r}

# list potential values of K
k_list <- seq(5, 50, 5)

# create empty data frames for predictions
maxent_df <- data.frame()
brt_df <- data.frame()



# model predictions for all value of k
for (i in k_list) {
  
  # maxent predictions
  print(paste0("Maxent modeling with k = ", i))
  maxent_results <- tune_maxent(3, point_dir, rast_dir, i, 1000)
  maxent_gs <- maxent_results[["maxent_gs"]]
  
  # add to data frame
  new_row <- as.data.frame(maxent_gs@results) %>% slice_max(order_by = test_AUC)
  new_row$k <- i
  maxent_df <- rbind(maxent_df, new_row)
  
  # BRT predictions
  print(paste0("BRT modeling with k = ", i))
  brt_results <- tune_brt(3, point_dir, rast_dir, i, 1000)
  brt_gs <- brt_results[["brt_gs"]]
  
  # add to data frame
  new_row <- as.data.frame(brt_gs@results) %>% slice_max(order_by = test_AUC)
  new_row$k <- i
  brt_df <- rbind(brt_df, new_row)
}

# save results
write_csv(brt_df, here("outputs", "input-auc-assessment", "brt_k_folds.csv"))
write_csv(maxent_df, here("outputs", "input-auc-assessment", "maxent_k_folds.csv"))

# plot results
ggplot(brt_df, aes(k, test_AUC)) +
  geom_point(col = "darkorange3", size = 2) +
  geom_smooth(se = FALSE, col = "darkorange") +
  theme_minimal() +
  labs(y = "Test AUC", title = "BRT K-fold Assessment")

ggplot(maxent_df, aes(k, test_AUC)) +
  geom_point(col = "darkblue", size = 2) +
  geom_smooth(se = FALSE) +
  theme_minimal() +
  labs(y = "Test AUC", title = "Maxent K-fold Assessment")

```


## Comparing the Number of Background Points

```{r}
# ..........................calculate AUC for varying bg_points...................
# list potential number of background points
bg_list <- c(10, 120, 230, 340, 450, 560, 670, 780, 890, 1000)

# create empty data frames for predictions
maxent_df1 <- data.frame()
brt_df2 <- data.frame()


# model predictions for all number of bg points
for (i in bg_list) {
  
  # # maxent predictions
  # print(paste0("maxent modeling with bg_points = ", i))
  # maxent_results <- tune_maxent(3, point_dir, rast_dir, 5, i)
  # maxent_gs <- maxent_results[["maxent_gs"]]
  # 
  # # add to data frame
  # new_row <- as.data.frame(maxent_gs@results) %>% slice_max(order_by = test_AUC)
  # new_row$bg_points <- i
  # maxent_df1 <- rbind(maxent_df1, new_row)
  
  # BRT predictions
  print(paste0("brt modeling with bg_points = ", i))
  brt_results <- tune_brt(3, point_dir, rast_dir, 5, i)
  brt_gs <- brt_results[["brt_gs"]]
  
  # add to data frame
  new_row <- as.data.frame(brt_gs@results) %>% slice_max(order_by = test_AUC)
  new_row$bg_points <- i
  brt_df2 <- rbind(brt_df2, new_row)
}

# ...........................clean data.............................
brt_df1$only_presence <- "False"
brt_df2$only_presence <- "True"

brt_df_bg <- rbind(brt_df1, brt_df2)


# ..........................plot results............................

ggplot(maxent_df1, aes(bg_points, test_AUC)) +
  geom_point(col = "darkorange3", size = 2) +
  geom_smooth(se = FALSE, col = "darkorange") +
  labs(x = "Number of Background Points", y = "Test AUC", title = "Maxent - Baxkground Point Assessment") +
  theme_minimal()

ggplot(brt_df_bg, aes(bg_points, test_AUC, col = only_presence, shape = only_presence)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("maroon", "navy")) +
  geom_smooth(se = FALSE, aes(col = only_presence)) +
  labs(x = "Number of Background Points", y = "Test AUC", title = "BRT - Background Point Assessment") +
  theme_minimal()

```



##### Start old work

Modeling Iterate through all plots, storing predictions for each plot and model.

```{r}
# for (i in seq(1:2)) {
  
  # print progress statement
  print(paste0("Running Maxent Plot:", i))
  
  # run maxent model for all plots
  m_res <- tune_maxent(i, point_dir, rast_dir)
  rast <- m_res[[3]]
  
  # store results in final predictions folder
  write_rds(m_res, 
            file = here("outputs", "final-pred", paste0("maxent_p", i)), 
            compress = "gz")
  writeRaster(rast, 
              filename = here("outputs", "final-pred", paste0("maxent_rast_p", i)))
# }

```

Read in Results

```{r}
output_dir <- here("outputs", "final-pred")

# read in maxent files
for (i in 1:2) {
  m_res <- read_rds(paste0(output_dir, "/maxent_p", i))
  assign(paste0("maxent_res_p", i), m_res, envir = .GlobalEnv)
}
```

Predictions

```{r}
t_test <- maxent_res_p1[[2]]
t_gs <- maxent_res_p1[[4]]

best_locM <- which.max(t_gs@results$test_AUC)

# retrain model with best parameters for final prediction
best_modM <- combineCV(t_gs@models[[best_locM]])


plotROC(best_modM, test = t_test)

```
